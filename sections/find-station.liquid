{{ 'section-find-station.css' | asset_url | stylesheet_tag }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<section id="stations" class="find-station section-{{ section.id }}-padding">
  <div class="page-width text-center">
    {% if section.settings.heading %}
      <h2 class="find-station__heading">{{ section.settings.heading }}</h2>
    {% endif %}
    {% if section.settings.subheading %}
      <p class="find-station__subheading">{{ section.settings.subheading }}</p>
    {% endif %}

    <!-- Search -->
    <div class="find-station__search">
      <input
        id="station-search"
        type="text"
        class="find-station__input"
        placeholder="{{ section.settings.search_placeholder }}"
        aria-label="Pesquisar estação"
      >
      <button id="scroll-to-map" type="button" class="find-station__button">
        {{ section.settings.map_button_label }}
      </button>
    </div>

    <!-- Map -->
    <div id="map-container" class="find-station__map lazy-map">
      <div class="map-placeholder">Carregando mapa...</div>
    </div>

    <!-- Station Cards -->
    {% assign station_list = shop.metaobjects.station.values %}
    {% if station_list %}
      <div class="swiper find-station__cards">
        <div class="swiper-wrapper">
          {% for station in station_list %}
            <article
              class="swiper-slide find-station__card station-card"
              data-name="{{ station.name | downcase }}"
              data-city="{{ station.city | downcase }}"
              data-lat="{{ station.latitude }}"
              data-lng="{{ station.longitude }}"
            >
              <a href="/pages/{{ station.slug }}" class="station-link">
                <h3 class="find-station__card-title">{{ station.name }}</h3>
                {% if station.city %}
                  <p class="find-station__card-city">{{ station.city }}</p>
                {% endif %}

                {% if station.services %}
                  <div class="find-station__card-services">
                    {% for service in station.services.value limit: 3 %}
                      <div class="find-station__service">
                        {% if service.icon or service.name %}
                          <span>
                            <img
                              src="{{ service.icon | img_url: '24x24' }}"
                              alt="{{ service.name | escape }}"
                              loading="lazy"
                              width="17"
                              height="17"
                            >
                            {{ service.name }}
                          </span>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
              </a>
            </article>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- CTA -->
    {% if section.settings.cta_link and section.settings.cta_text %}
      <div class="find-station__cta">
        <a href="{{ section.settings.cta_link }}" class="find-station_cta_link">
          {{ section.settings.cta_text }}
          <span class="find-station_cta_icon">
            <svg width="20" height="25" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </span>
        </a>
      </div>
    {% endif %}
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    new Swiper('.find-station__cards', {
      slidesPerView: 1.2,
      spaceBetween: 16,
      grabCursor: true,
      loop: false,
      breakpoints: { 640: { slidesPerView: 2.2 }, 1024: { slidesPerView: 3.5 } },
    });

    document.querySelector('#scroll-to-map')?.addEventListener('click', () => {
      document.querySelector('#map-container').scrollIntoView({ behavior: 'smooth', block: 'center' });
    });

    const mapContainer = document.querySelector('#map-container');
    const placeholder = mapContainer.querySelector('.map-placeholder');

    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) {
        initMap();
        observer.disconnect();
      }
    });
    observer.observe(mapContainer);

    function initMap() {
      if (placeholder) placeholder.remove();

      const map = L.map('map-container', {
        center: [39.6, -8.0],
        zoom: 7,
        scrollWheelZoom: false,
      });

      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
        subdomains: 'abcd',
        maxZoom: 19,
      }).addTo(map);

      const devesaIcon = L.divIcon({
        className: 'devesa-marker',
        html: '<div class="marker-dot"></div>',
        iconSize: [24, 24],
        iconAnchor: [12, 12],
        popupAnchor: [0, -10],
      });

      const stations = Array.from(document.querySelectorAll('.station-card'))
        .map((card) => {
          let rawLat = String(card.dataset.lat || '').trim();
          let rawLng = String(card.dataset.lng || '').trim();

          let lat = parseFloat(rawLat.replace(',', '.'));
          let lng = parseFloat(rawLng.replace(',', '.'));

          if (isNaN(lat) || isNaN(lng)) return null;

          if (lng > 0 && lng <= 15) lng = -lng;

          if (lat < -10 && lng > 30) [lat, lng] = [lng, lat];

          const inPortugal = lat >= 35 && lat <= 43 && lng >= -10.5 && lng <= -5;
          if (!inPortugal) {
            console.warn(
              `Skipped station: ${card.querySelector('.find-station__card-title').innerText} (lat: ${lat}, lng: ${lng})`
            );
            return null;
          }

          return {
            name: card.querySelector('.find-station__card-title').innerText,
            lat,
            lng,
            city: card.dataset.city,
            url: card.querySelector('a').href,
          };
        })
        .filter(Boolean);

      const markers = [];

      stations.forEach((station, i) => {
        const marker = L.marker([station.lat, station.lng], { icon: devesaIcon })
          .addTo(map)
          .bindPopup(
            `<div class="popup-content">
           <strong>${station.name}</strong><br>
           ${station.city}<br>
           <a href="${station.url}" target="_blank">Ver estação</a>
         </div>`
          );
        marker.on('click', () => highlightCard(i));
        markers.push(marker);
      });

      if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds(), { padding: [40, 40] });
        setTimeout(() => {
          map.invalidateSize();
          map.fitBounds(group.getBounds(), { padding: [40, 40] });
        }, 400);
      }

      document.querySelectorAll('.station-card').forEach((card, i) => {
        card.addEventListener('click', (e) => {
          e.preventDefault();
          if (markers[i]) {
            map.setView(markers[i].getLatLng(), 13);
            markers[i].openPopup();
          }
        });
      });

      const searchInput = document.querySelector('#station-search');
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        const visibleMarkers = [];

        document.querySelectorAll('.station-card').forEach((card, i) => {
          const name = card.dataset.name;
          const city = card.dataset.city;
          const visible = name.includes(query) || city.includes(query);
          card.style.display = visible ? 'block' : 'none';

          if (visible && markers[i]) {
            markers[i].addTo(map);
            visibleMarkers.push(markers[i]);
          } else if (markers[i]) {
            map.removeLayer(markers[i]);
          }
        });

        if (visibleMarkers.length === 1) {
          map.setView(visibleMarkers[0].getLatLng(), 13);
        } else if (visibleMarkers.length > 1) {
          const group = new L.featureGroup(visibleMarkers);
          map.fitBounds(group.getBounds(), { padding: [40, 40] });
        } else {
          map.setView([39.6, -8.0], 7);
        }
      });

      function highlightCard(index) {
        document.querySelectorAll('.station-card').forEach((card, i) => {
          card.classList.toggle('active', i === index);
        });
      }
    }
  });
</script>

<style>
  #map-container {
    min-height: 400px;
    background: linear-gradient(135deg, #f6f6f6, #ededed);
    border-radius: 12px;
    overflow: hidden;
  }

  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  #stations {
    background-color: {{ section.settings.section_background_color }};
  }

  .devesa-marker {
    background: #0e2147;
    border: 2px solid #fff;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .devesa-marker .marker-dot {
    width: 10px;
    height: 10px;
    background: #ff7b00;
    border-radius: 50%;
  }

  /* Compact, readable popup */
  .leaflet-popup-content-wrapper {
    padding: 10px 20px;
    border-radius: 8px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
    max-width: 260px;
  }

  .leaflet-popup-content {
    font-size: 1.45rem;
    color: #0e2147;
    line-height: 1.3;
    margin: 4px 0;
  }

  .leaflet-popup-content strong {
    display: block;
    margin-bottom: 3px;
    font-weight: 600;
    color: #0e2147;
  }

  .leaflet-popup-content a {
    color: #ff7b00;
    font-weight: 500;
    text-decoration: underline;
  }

  .station-card.active {
    border: 2px solid #ff7b00;
    transform: scale(1.02);
    transition: all 0.2s ease-in-out;
  }

  .find-station_cta_icon {
    display: flex;
  }
</style>

{% schema %}
{
  "name": "Find Your Station",
  "tag": "section",
  "class": "section",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Encontre a estação Devesa mais próxima" },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Descubra onde pode abastecer, relaxar e recarregar com os serviços Devesa."
    },
    {
      "type": "text",
      "id": "search_placeholder",
      "label": "Search placeholder",
      "default": "Pesquisar por local, cidade ou nome..."
    },
    { "type": "text", "id": "map_button_label", "label": "Map button label", "default": "Ver no mapa" },
    { "type": "text", "id": "cta_link", "label": "CTA Link", "default": "/mapa" },
    { "type": "text", "id": "cta_text", "label": "CTA Text", "default": "Ver todas as estações" },
    {
      "type": "color",
      "id": "section_background_color",
      "label": "Section Background Color",
      "default": "#FFFFFF"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 60
    }
  ],
  "presets": [{ "name": "Find Your Station" }]
}
{% endschema %}
